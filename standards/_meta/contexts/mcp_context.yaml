# MCPサーバーコンテキスト定義

version: "1.2.0"
type: "mcp_context"

# MCPプロトコル標準定義
protocol_standard:
  transport:
    type:
      enum: ["stdio", "http_sse"]
      description: "標準トランスポート層タイプ"
    timeout: 30
    retry:
      max_attempts: 3
      backoff: "exponential"

  message_format:
    jsonrpc: "2.0"
    error_codes:
      parse_error: -32700
      invalid_request: -32600
      method_not_found: -32601
      invalid_params: -32602
      internal_error: -32603
      server_error_start: -32000

# サーバー基本設定
server_config:
  command:
    type: "string"
    required: true
    description: "サーバー実行コマンド"
  
  args:
    type: "array"
    required: true
    description: "コマンド引数"
  
  disabled:
    type: "boolean"
    default: false
    description: "無効化フラグ"
  
  alwaysAllow:
    type: "array"
    default: []
    description: "常に許可する操作"

# サーバー機能定義
capabilities:
  resources:
    enabled: false
    description: "データとコンテンツの提供機能"
  
  tools:
    enabled: false
    description: "実行可能な機能の提供"
  
  prompts:
    enabled: false
    description: "再利用可能なプロンプトテンプレート"
  
  sampling:
    enabled: false
    description: "LLMからの補完要求機能"

# サーバー定義
server_definition:
  server_type:
    type: "string"
    required: true
    enum: ["python", "node", "custom"]
    description: "MCPサーバーの実行環境タイプ"
    reference: "standards/processes/mcp/server_types.yaml"
    validation:
      runtime_check: true
      dependency_check: true
      compatibility_check: true
  
  api_endpoints:
    base_url: "string"
    version: "string"
    rate_limits:
      requests_per_second: "number"
      burst_limit: "number"
    timeout:
      connect: "number"
      read: "number"
      write: "number"
  
  scaling_config:
    required: false
    description: "スケーリング設定（オプショナル）"
    properties:
      min_instances:
        type: "number"
        default: 1
      max_instances:
        type: "number"
        default: 1
      auto_scaling:
        type: "object"
        required: false
        properties:
          enabled:
            type: "boolean"
            default: false
          metrics:
            type: "array"
            required: false
            description: "スケーリングメトリクス（オプショナル）"
            reference: "unified_metrics.yaml#base_metrics"

# 必要な知識ベース
required_knowledge:
  server_architecture:
    description: "MCPサーバーのアーキテクチャ理解"
    components:
      - "通信プロトコル"
      - "認証メカニズム"
      - "エラーハンドリング"
      - "状態管理"
  
  authentication_methods:
    description: "認証方式の理解"
    types:
      - "環境変数ベース"
      - "トークンベース"
      - "OAuth認証"
  
  error_handling:
    description: "エラー処理パターン"
    patterns:
      - "認証エラー"
      - "通信エラー"
      - "タイムアウト"
      - "リソース不足"

# 状態追跡
state_tracking:
  installation:
    states:
      - "not_started"
      - "in_progress"
      - "completed"
      - "failed"
    transitions:
      - from: "not_started"
        to: "in_progress"
        triggers: ["setup_initiated"]
        validation: "environment_check"
      - from: "in_progress"
        to: "completed"
        triggers: ["setup_successful"]
        validation: "completion_check"
      - from: "in_progress"
        to: "failed"
        triggers: ["setup_error"]
        validation: "error_analysis"
  
  configuration:
    states:
      - "unconfigured"
      - "partially_configured"
      - "fully_configured"
      - "invalid"
    transitions:
      - from: "unconfigured"
        to: "partially_configured"
        triggers: ["config_started"]
        validation: "config_check"
      - from: "partially_configured"
        to: "fully_configured"
        triggers: ["config_completed"]
        validation: "config_validation"
      - from: "fully_configured"
        to: "invalid"
        triggers: ["config_error"]
        validation: "error_validation"

# 非同期処理管理
async_processing:
  state_management:
    enabled: true
    checkpoints:
      required: true
      interval: "number"
      timeout: "number"
      storage_pattern:
        reference: "async_storage_patterns.yaml#checkpoint_storage"
        default: "memory_based"
    recovery:
      auto_retry: true
      max_retries: 3
      backoff_strategy: "exponential"
  
  task_tracking:
    unique_id: true
    status_updates:
      frequency: "realtime"
      persistence: true
      format:
        reference: "async_storage_patterns.yaml#progress_tracking.format"
      storage_pattern:
        reference: "async_storage_patterns.yaml#pattern_storage"
        default: "memory"
    completion_verification:
      required: true
      timeout: 300

# プロセス間通信（IPC）
ipc_configuration:
  communication_types:
    - type: "message_queue"
      protocol: "AMQP"
      reliability: "at_least_once"
      metrics:
        reference: "unified_metrics.yaml#base_metrics.resource"

    - type: "shared_memory"
      access_mode: "read_write"
      sync_mechanism: "mutex"
      metrics:
        reference: "unified_metrics.yaml#base_metrics.system"

    - type: "socket"
      protocol: "TCP"
      encryption: true
      metrics:
        reference: "unified_metrics.yaml#base_metrics.performance"
  
  message_patterns:
    - pattern: "request_response"
      timeout: 30
      retry_policy: "exponential_backoff"
      metrics:
        - name: "response_time"
          type: "histogram"
          description: "リクエスト-レスポンス時間（ms）"
          threshold: 1000
          alert_level: "warning"
        - name: "retry_count"
          type: "counter"
          description: "リトライ回数"
          threshold: 3
          alert_level: "warning"

    - pattern: "publish_subscribe"
      delivery_guarantee: "at_least_once"
      metrics:
        - name: "subscriber_count"
          type: "gauge"
          description: "アクティブなサブスクライバー数"
          threshold: 100
          alert_level: "info"
        - name: "message_rate"
          type: "rate"
          description: "メッセージ配信率（msg/s）"
          threshold: 1000
          alert_level: "warning"

    - pattern: "stream"
      buffer_size: 1024
      metrics:
        - name: "buffer_usage"
          type: "gauge"
          description: "バッファ使用率"
          threshold: 80
          alert_level: "warning"
        - name: "throughput"
          type: "rate"
          description: "データスループット（MB/s）"
          threshold: 100
          alert_level: "warning"

# メモリ要件
memory_requirements:
  previous_configurations:
    type: "persistent"
    storage: "file"
    path: "validations/history/config_history.yaml"
    retention_period: 30
  
  error_patterns:
    type: "learning"
    storage:
      type: "memory"
      persistence: true
    update_frequency: "on_error"
  
  successful_patterns:
    type: "learning"
    storage:
      type: "memory"
      persistence: true
    update_frequency: "on_success"

# 操作パターン
operation_patterns:
  setup:
    steps:
      - "環境チェック"
      - "依存関係インストール"
      - "初期設定"
      - "動作確認"
    validation_points:
      - after: "環境チェック"
        check: "environment_validation"
      - after: "初期設定"
        check: "configuration_validation"
  
  configuration:
    steps:
      - "設定ファイル作成"
      - "環境変数設定"
      - "認証情報設定"
      - "接続テスト"
    validation_points:
      - after: "設定ファイル作成"
        check: "file_validation"
      - after: "認証情報設定"
        check: "auth_validation"

# エラー管理定義
error_management:
  # 標準エラーコード範囲（MCPフレームワーク準拠）
  error_codes:
    parse_error: -32700
    invalid_request: -32600
    method_not_found: -32601
    invalid_params: -32602
    internal_error: -32603
    server_error_range:
      start: -32000
      end: -32099

  # 重要度レベル（MCPフレームワーク標準準拠）
  severity_levels:
    critical:
      response_time: 15  # 分単位
      description: "即時対応（15分以内）"
      conditions:
        - "システム全体の機能停止"
        - "重大なセキュリティ違反"
        - "データ損失のリスク"
      error_codes: [-32700, -32603]  # 最重要エラー

    high:
      response_time: 60  # 分単位
      description: "1時間以内の対応"
      conditions:
        - "主要機能の部分的な停止"
        - "パフォーマンスの深刻な低下"
        - "データ整合性の問題"
      error_codes: [-32602, -32601]  # 重要エラー

    low:
      response_time: 1440  # 分単位
      description: "24時間以内の対応"
      conditions:
        - "軽微な機能の不具合"
        - "パフォーマンスの軽度な低下"
        - "非重要な警告"
      error_codes: [-32600, -32000]  # 一般エラー

  # リカバリー戦略
  recovery_strategies:
    automatic:
      conditions:
        - error_type: "connection_timeout"
          max_retries: 3
          retry_interval: 1000  # ミリ秒
          backoff: "exponential"
        - error_type: "rate_limit"
          max_retries: 5
          retry_interval: 5000
          backoff: "linear"
      
      resource_thresholds:
        cpu_usage: 80
        memory_usage: 90
        disk_space: 85
    
    manual:
      conditions:
        - error_type: "authentication_failed"
          notification: ["system_admin"]
          required_action: "token_refresh"
        - error_type: "permission_denied"
          notification: ["system_admin", "security_team"]
          required_action: "permission_review"

  # エラーレポート形式（MCPフレームワーク標準準拠）
  error_reporting:
    format:
      code: "number"  # エラーコード
      message: "string"  # エラーメッセージ
      data:  # 追加情報（オプショナル）
        type: "object"
        properties:
          timestamp: "string"
          severity: "string"
          context: "object"
          stack_trace: "string"

# モニタリング設定の参照
monitoring_configuration:
  reference: "global_context.monitoring_settings"
  server_specific_metrics:
    reference: "unified_metrics.yaml#base_metrics.performance"

# 学習パターンの参照
learning_patterns:
  reference: "global_context.ai_agent_settings.learning_patterns"
  server_specific_patterns:
    - name: "api_interaction"
      description: "APIインタラクションパターン"
    - name: "server_lifecycle"
      description: "サーバーライフサイクル管理パターン"

# 更新履歴
history:
  - version: "1.2.0"
    date: "2025-01-12"
    description: "MCPフレームワーク仕様への完全準拠"
    author: "Cline AI"
    changes:
      - "MCPプロトコル標準定義の追加（トランスポート層、JSON-RPCメッセージフォーマット）"
      - "エラー管理の標準化（エラーコード範囲、重要度レベル、レポート形式）"
      - "サーバー機能（capabilities）の明確化"
      - "エラー重要度とエラーコードの関連付け"
      - "リカバリー戦略の整理"
  - version: "1.1.0"
    date: "2025-01-11"
    description: "MCPサーバー定義の強化、非同期処理管理の追加、IPCの強化、エラー重要度の追加、整合性の改善"
    author: "Cline AI"
  - version: "1.0.0"
    date: "2025-01-11"
    description: "初期バージョン"
    author: "Cline AI"