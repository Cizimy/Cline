# スキーマ・コンテキスト定義の検証テスト計画

## 概要

このテストスイートは、MCPフレームワークのスキーマとコンテキスト定義の検証を自動化します。以下の主要な検証領域をカバーします：

1. スキーマ検証（validate_schemas.py）
2. 非同期処理・パフォーマンステスト（test_async_performance.py）
3. セキュリティテスト（test_security.py）

## 前提条件

- Python 3.10以上
- 必要なPythonパッケージ:
  ```bash
  pip install pyyaml jsonschema aiohttp asyncio
  ```

## テストの実行方法

1. 単一のテストスクリプトの実行:
   ```bash
   python validate_schemas.py ../
   python test_async_performance.py ../
   python test_security.py ../
   ```

2. すべてのテストの一括実行:
   ```bash
   python run_tests.py ../
   ```

## テスト内容

### 1. スキーマ検証 (validate_schemas.py)

#### 1.1 ファイル構造の検証
- 必須ファイルの存在確認
- YAMLシンタックスの検証
- インデントの正確性チェック
- 文字エンコーディングの確認（UTF-8）

#### 1.2 バージョン管理の検証
- バージョン番号の一貫性確認（v1.2.0）
- 更新履歴の整合性検証
- 変更内容の相互依存関係の確認
- 更新日時の時系列整合性

#### 1.3 スキーマ定義の検証
- context_schema.yamlの検証
  - MCPプロトコル定義の妥当性
  - コンテキストタイプの定義
- process_schema.yamlの検証
  - プロセスタイプの定義
  - 非同期処理の定義
- validation_schema.yamlの検証
  - バリデーションタイプの定義
  - 前提条件の検証

#### 1.4 コンテキスト定義の検証
- 必須フィールドの存在確認
- 参照整合性の検証
- 列挙型の値の一貫性
- デフォルト値の妥当性

#### 1.5 エラー定義の検証
- 標準エラーコードの検証（-32700～-32603）
- サーバー固有エラーコードの検証（-32099～-32000）
- エラー重要度の検証
  - Critical: 15分以内
  - High: 60分以内
  - Low: 24時間以内

### 2. 非同期処理・パフォーマンステスト (test_async_performance.py)

#### 2.1 非同期処理の信頼性テスト
- 並行処理の安定性検証
- エラーハンドリングの検証
- リソース管理の検証
- デッドロック検出

#### 2.2 パフォーマンステスト
- レスポンスタイムの測定
- スループットの検証
- リソース使用率の監視
- スケーラビリティの検証

#### 2.3 負荷テスト
- 高負荷時の動作検証
- メモリリークの検出
- エラー率の測定
- リカバリー機能の検証

#### 2.4 リモートMCP接続のパフォーマンス
- サービスディスカバリーの応答時間測定
  * DNS方式の検証
  * HTTP方式の検証
  * 手動設定方式の検証
- 認証処理のオーバーヘッド測定
  * OAuth2認証の性能
  * トークン認証の性能
- ステートレス操作の性能測定
  * リクエストごとの認証オーバーヘッド
  * セッション管理のオーバーヘッド
- 接続の安定性検証
  * 再接続処理の性能
  * タイムアウト処理の効率

### 3. セキュリティテスト (test_security.py)

#### 3.1 認証・認可の検証
- トークン管理の検証
- 権限設定の検証
- セッション管理の検証
- アクセス制御の検証

#### 3.2 データセキュリティ
- 機密情報の保護
- データ暗号化の検証
- 入力バリデーション
- SQLインジェクション対策

#### 3.3 通信セキュリティ
- TLS設定の検証
- 証明書の検証
- プロトコルセキュリティ
- レート制限の検証

#### 3.4 リモートMCP接続のセキュリティ
- サービスディスカバリーのセキュリティ
  * DNSセキュリティ（DNSSEC）
  * HTTPSとSSL/TLS検証
  * 証明書ピン留めの検証
- ステートレス通信のセキュリティ
  * リクエストごとの認証
  * 状態管理の制限
  * セッション分離
- 接続タイムアウトとリトライ
  * タイムアウト設定の検証
  * リトライ回数の制限
  * エラーハンドリング

## テスト結果の判定基準

### 合格基準
1. すべてのYAMLファイルが構文的に正しいこと
2. すべての必須フィールドが存在すること
3. バージョン番号が一貫していること
4. 相互参照が正確であること
5. エラーコードと重要度の定義が仕様通りであること
6. パフォーマンス指標が基準値を満たすこと
7. セキュリティ要件を満たすこと

### 警告条件
1. 非推奨の値や構造の使用
2. 冗長な定義の存在
3. ドキュメント不足
4. パフォーマンス低下の兆候
5. セキュリティ上の潜在的リスク

### 失敗条件
1. YAML構文エラー
2. 必須フィールドの欠落
3. バージョン番号の不一致
4. 無効な相互参照
5. 仕様外のエラーコード定義
6. 重大なパフォーマンス問題
7. セキュリティ脆弱性

## テスト結果のレポート

テスト実行後、以下のレポートが生成されます：

1. validation_report.md: スキーマ検証結果
2. async_performance_report.md: 非同期処理・パフォーマンステスト結果
3. security_report.md: セキュリティテスト結果
4. test_summary_report.md: 総合テスト結果

各レポートには以下の情報が含まれます：
- テスト実行日時
- テスト結果サマリー
- 詳細なエラーまたは警告メッセージ
- 改善提案
- 次のステップの推奨事項

## 継続的改善

1. テストカバレッジの拡大
   - 新しいテストケースの追加
   - エッジケースの検証強化
   - 自動化範囲の拡大

2. テスト効率の改善
   - テスト実行時間の最適化
   - リソース使用の効率化
   - 並列実行の導入

3. レポーティングの強化
   - より詳細な分析情報
   - トレンド分析の追加
   - 視覚化の改善

## トラブルシューティング

### よくある問題と解決方法

1. テスト実行エラー
   ```
   原因: Python環境の問題
   解決: 必要なパッケージのインストール確認
   ```

2. YAML構文エラー
   ```
   原因: インデントまたは特殊文字の問題
   解決: YAMLバリデーターでの確認
   ```

3. パフォーマンステスト失敗
   ```
   原因: システムリソースの不足
   解決: 他のプロセスの終了または設定の調整
   ```

### サポート

問題が解決しない場合は、以下を確認してください：
1. ログファイル
2. システムリソース使用状況
3. ネットワーク接続状態
4. 環境変数設定

## 参考情報

- [MCPフレームワーク仕様書](https://modelcontextprotocol.io/introduction)
- [JSONスキーマ仕様](https://json-schema.org/)
- [YAMLスペック](https://yaml.org/spec/)