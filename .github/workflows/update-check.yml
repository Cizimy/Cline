name: Update Check

on:
  schedule:
    - cron: "0 0 * * 1" # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰0æ™‚ã«å®Ÿè¡Œ
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for updates
        id: check
        run: |
          if ! npm run check:updates; then
            echo "Updates available"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "No updates available"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const updateReport = fs.readFileSync(process.stdout.fd, 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ æ›´æ–°ãŒåˆ©ç”¨å¯èƒ½ã§ã™',
              body: `
              # æ›´æ–°ãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ
              
              ${updateReport}
              
              ## æ›´æ–°æ‰‹é †
              
              1. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯ã‚¹ã‚¿ãƒƒã‚·ãƒ¥ã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹
              2. \`npm run update\` ã‚’å®Ÿè¡Œ
              3. æ›´æ–°å¾Œã€\`npm run build\` ã§å‹•ä½œç¢ºèª
              4. ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
              
              æ›´æ–°ã«å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€å€‹åˆ¥ã« \`npm run update:submodules\` ã¾ãŸã¯ \`npm run update:deps\` ã‚’å®Ÿè¡Œã—ã¦æ›´æ–°ç¯„å›²ã‚’åˆ¶é™ã§ãã¾ã™ã€‚
              `,
              labels: ['dependencies', 'automated']
            });
